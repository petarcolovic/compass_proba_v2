<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The 4C Culture Compass™ by Recrewty</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("buMM4aYEM_n4bPDZI");
    })();
  </script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#f8f9fa;
      --muted:#6c757d;
      --text:#333333;
      --accent:#38B000;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.5;
    }
    .wrap{max-width:1200px;margin:auto;padding:24px}
    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin:16px 0 24px;
    }
    header img{height:40px}
    h1{font-size:26px;margin:0}
    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.1);
    }
    .intro{padding:16px 20px;margin-bottom:16px}
    .q{padding:16px 20px;border-top:1px solid rgba(0,0,0,.06);}
    .q:first-child{border-top:none}
    .q h3{font-size:16px;margin:0 0 12px}
    .scale{display:flex;gap:10px;flex-wrap:wrap}
    .scale label {
      display:flex;align-items:center;gap:8px;
      background:#ffffff;border:2px solid var(--accent);
      color:#333;padding:8px 12px;border-radius:12px;
      cursor:pointer;transition:all 0.2s ease;
    }
    .scale label:hover { background:var(--accent); color:#ffffff; }
    .scale input { accent-color:var(--accent); }
    .actions{display:flex;gap:12px;justify-content:flex-end;padding:14px 20px;border-top:1px solid rgba(0,0,0,.06)}
    button{background:var(--accent);border:none;color:#fff;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:20px}
    @media (min-width: 980px){ .grid{grid-template-columns:1fr 1fr} }
    .result{padding:16px 20px;text-align:center}
    .best-card{padding:16px 20px;border-top:1px solid rgba(0,0,0,.06);text-align:left}
    .best-card h2{margin:0 0 6px}
    a{color:#38B000}
    .small{font-size:12px}
    .dim-desc{margin:12px 0;font-size:14px;line-height:1.4;text-align:left}
    .legend{margin-top:10px;font-size:13px}
    .legend span{margin:0 10px}
    .compass-bg{position:relative;display:inline-block}
    .compass-bg img{width:400px;height:400px;display:block}
    .compass-bg canvas{position:absolute;left:0;top:0}
    .label{
      position:absolute;font-size:13px;font-weight:600;color:#444;
      background:rgba(255,255,255,0.8);padding:2px 6px;border-radius:6px;
      transform:translate(-50%,-50%);
    }
    #statusMsg{padding:10px 20px;font-size:14px;color:var(--accent);}
    #emailBox{margin-top:25px;text-align:center;padding:10px 20px;}
    #emailBox input{
      width:80%;max-width:400px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;
    }
    #emailFeedback{font-size:13px;margin-top:6px;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <a href="https://recrewty.com" target="_blank" rel="noopener">
        <img src="recrewty-logo-white.png" alt="Recrewty logo"/>
      </a>
      <h1>The 4C Culture Compass™ by Recrewty</h1>
    </header>

    <div class="grid">
      <!-- Left: questions -->
      <form id="quiz" class="card">
        <div class="intro">
          <p class="muted">
            Please rate each statement from 1 (strongly disagree) to 5 (strongly agree).
          </p>
        </div>
        <div id="questions"></div>
        <div id="statusMsg"></div>
        <div class="actions">
          <button type="submit">Show Results</button>
          <button type="button" id="resetBtn" class="muted"
                  style="background:transparent;color:var(--text);border:1px solid rgba(0,0,0,.12)">Reset</button>
        </div>
      </form>

      <!-- Right: results -->
      <section id="output" class="card" aria-live="polite">
        <div class="result">
          <h2>Test Results</h2>
          <div class="compass-bg" style="position:relative;">
            <img src="compass.svg" alt="Compass background"/>
            <canvas id="compassCanvas" width="400" height="400"></canvas>
            <!-- Axis labels -->
            <div class="label" style="top:10px;left:50%;">C1</div>
            <div class="label" style="top:50%;left:95%;">C2</div>
            <div class="label" style="bottom:10px;left:50%;">C3</div>
            <div class="label" style="top:50%;left:5%;">C4</div>
          </div>
          <div id="legend"></div>
        </div>
        <div id="summary" class="best-card"></div>
        <div id="details"></div>

        <!-- Email box below results -->
        <div id="emailBox">
          <p class="muted">Would you like a detailed report? Enter your e-mail (optional):</p>
          <input type="email" id="userEmail" placeholder="your@email.com" />
          <button type="button" id="sendEmailBtn">Send Results</button>
          <div id="emailFeedback"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    let ITEMS = [];
    let FIGURES = [];
    let LAST_RESULT = null;

    async function loadData(){
      const itemsRes = await fetch("items.json");
      ITEMS = await itemsRes.json();
      const figuresRes = await fetch("figures.json");
      FIGURES = await figuresRes.json();
      renderQuestions();
    }

    const DIMS_INFO = {
      "C1": {"name":"Clarity & Compliance vs Agility","high":"Structured Culture - Emphasizes rules, consistency, SOPs. Predictable, process-driven, ideal for scaling operations.","low":"Agile Culture - Values flexibility, improvisation, and informal processes. Good for startups, creative teams, or fast pivots."},
      "C2": {"name":"Competitive Achievement","high":"Performance-Driven Culture - Values competition, ambition, and personal wins. Ideal for sales, finance, high-stakes roles.","low":"Empathetic Culture - Focused on emotional intelligence, harmony, and consensus. Ideal for care-based sectors or internal-facing roles."},
      "C3": {"name":"Collective Loyalty","high":"Team-First Culture - Prioritizes group harmony, shared credit, and loyalty. Strong cohesion and retention.","low":"Individualist Culture - Encourages autonomy, self-expression, and personal goals. Energizing but can reduce cohesion."},
      "C4": {"name":"Commitment to Growth","high":"Growth-Oriented Culture - Values planning, long-term thinking, perseverance, and saving resources for the future.","low":"Present-Oriented Culture - Optimized for short-term gains, flexibility, and immediate feedback loops. Can be highly reactive."}
    };

    const DIMS = ["C1","C2","C3","C4"];
    const qWrap = document.getElementById('questions');
    const legendDiv = document.getElementById('legend');
    const summaryDiv = document.getElementById('summary');
    const detailsDiv = document.getElementById('details');

    function renderQuestions(){
      qWrap.innerHTML = '';
      ITEMS.forEach(q=>{
        const div=document.createElement('div');
        div.className='q';
        div.innerHTML=`
          <h3>${q.id}. ${q.text}</h3>
          <div class="scale">
            ${[1,2,3,4,5].map(v=>`
              <label>
                <input type="radio" name="q_${q.id}" value="${v}" required /> ${v}
              </label>`).join('')}
          </div>
          <div class="small muted">Scale: 1 = strongly disagree • 5 = strongly agree</div>`;
        qWrap.appendChild(div);
      });
    }

    function computeRawScores(form){
      const sums={};
      ITEMS.forEach(q=>{sums[q.dim]=(sums[q.dim]||0)+Number(form.get(`q_${q.id}`)||0);});
      return sums;
    }

    // ---------- NORM SECTION START ----------
    // Excel-based norms embedded as { raw_sum -> normed_score } (from your C1–C4 spreadsheets)
    const NORMS = {
      "C1": {"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0,"11":15.082720432896519,"12":22.74539347017429,"13":28.03186449575069,"14":32.41832864446662,"15":37.28490533238744,"16":42.8939184353183,"17":47.94154147577759,"18":52.60920385845435,"19":58.032493413709135,"20":63.56771475254763,"21":69.55207775313915,"22":75.42383643601131,"23":81.4767938656201,"24":88.19958030249376,"25":100.0},
      "C2": {"6":0.0,"7":8.000704098685949,"8":15.2888536041387,"9":21.347258530004482,"10":26.077858982298223,"11":30.24701377471495,"12":34.79635119959213,"13":40.05469001626181,"14":44.686942915270305,"15":48.51656456684791,"16":52.47575930944069,"17":56.40872722741433,"18":60.05397930048485,"19":63.86999975227417,"20":67.55350191111128,"21":71.46804656831895,"22":76.1509729187757,"23":80.91489805861666,"24":85.7416005546197,"25":90.43372483516333,"26":95.22645797438289,"27":98.38220925400324,"28":100.0,"29":100.0,"30":100.0},
      "C3": {"6":0.0,"7":5.714537118960193,"8":14.5265366872617,"9":20.839060483742836,"10":25.010616872473983,"11":27.78891134096443,"12":30.92393246130817,"13":33.77416393614026,"14":36.50128359218865,"15":39.983033303047796,"16":43.99735605254201,"17":48.16786193067325,"18":52.682650707612014,"19":56.58389758561267,"20":59.16025670842674,"21":62.30942397084529,"22":66.1985106101636,"23":69.62521667611356,"24":73.01144250218441,"25":76.20808953656791,"26":79.46777801929836,"27":83.26706386295747,"28":87.13842507845501,"29":91.85249052560833,"30":100.0},
      "C4": {"5":0.0,"6":0.0,"7":0.0,"8":0.0,"9":0.0,"10":0.0,"11":17.125447655803527,"12":24.206049083943545,"13":30.25603621034082,"14":36.38496269520137,"15":42.51178764203215,"16":48.81721906553483,"17":55.14687894505392,"18":61.7183409518323,"19":68.33391128862594,"20":74.82588424985756,"21":81.34042302389727,"22":88.72142921702103,"23":94.0,"24":98.0,"25":100.0}
    };

    // Linear interpolation lookup: raw sum -> normed score
    function normLookup(dim, raw){
      const table = NORMS[dim];
      if(!table) return 0;
      const key = String(raw);
      if (table[key] !== undefined) return table[key];

      // sort numeric keys
      const keys = Object.keys(table).map(k => Number(k)).sort((a,b)=>a-b);
      if (keys.length === 0) return 0;
      if (raw <= keys[0]) return table[String(keys[0])];
      if (raw >= keys[keys.length-1]) return table[String(keys[keys.length-1])];

      // find neighbors for interpolation
      let i = 0; while (i < keys.length && keys[i] < raw) i++;
      const k2 = keys[i], k1 = keys[i-1];
      const v1 = table[String(k1)], v2 = table[String(k2)];
      const t = (raw - k1) / (k2 - k1);
      return v1 + t * (v2 - v1);
    }
    // ---------- NORM SECTION END ------------

    // Pearson correlation (Koen’s similarity)
    function profileSimilarity(user, fig){
      const u=DIMS.map(d=>user[d]||0);
      const f=DIMS.map(d=>fig[d]||0);
      const meanU=u.reduce((a,b)=>a+b,0)/u.length;
      const meanF=f.reduce((a,b)=>a+b,0)/u.length;
      let num=0,denU=0,denF=0;
      for(let i=0;i<DIMS.length;i++){
        num+=(u[i]-meanU)*(f[i]-meanF);
        denU+=(u[i]-meanU)**2;
        denF+=(f[i]-meanF)**2;
      }
      return num/Math.sqrt(denU*denF || 1e-9);
    }

    function drawCompass(user,figure){
      const canvas=document.getElementById('compassCanvas');
      const ctx=canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const size=canvas.width;
      const radius=size*0.36;
      const centerX=size/2,centerY=size/2;
      const angles=[-Math.PI/2,0,Math.PI/2,Math.PI];

      function drawPoly(obj,color){
        ctx.beginPath();
        DIMS.forEach((dim,i)=>{
          const val=obj[dim]||0;
          const r=(val/100)*radius;
          const x=centerX+r*Math.cos(angles[i]);
          const y=centerY+r*Math.sin(angles[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath();
        ctx.fillStyle=color.replace('1)','0.3)');
        ctx.fill();
        ctx.strokeStyle=color;
        ctx.lineWidth=2;
        ctx.stroke();
      }

      drawPoly(user,'rgba(56,176,0,1)');      // user (green)
      drawPoly(figure,'rgba(255,110,110,1)'); // best figure (red)
    }

    async function sendEmail(email, best, sim, scores){
      const feedback = document.getElementById('emailFeedback');
      feedback.style.color = "#38B000";
      feedback.textContent = "Sending...";
      try {
        await emailjs.send("service_scxnyg8","template_9asmc9m",{
          subject: "Recrewty Report – Culture Compass Results",
          // Put all recipients into 'to_email' to avoid template-level issues
          to_email: `danilo.d@recrewty.com, petar.colovic@uns.ac.rs, ${email}`,
          user_email: email,
          best_name: best.name,
          best_sim: sim.toFixed(2),
          C1: scores["C1"].toFixed(2),
          C2: scores["C2"].toFixed(2),
          C3: scores["C3"].toFixed(2),
          C4: scores["C4"].toFixed(2)
        });
        feedback.textContent = "✅ Results successfully sent to your email (and Recrewty team).";
      } catch (err) {
        feedback.style.color = "#d9534f";
        feedback.textContent = "⚠️ Failed to send email. Please try again later.";
      }
    }

    document.getElementById('quiz').addEventListener('submit', e=>{
      e.preventDefault();

      // 1) raw sums
      const form=new FormData(e.target);
      const raw=computeRawScores(form);

      // 2) normed scores via lookup + interpolation
      const normed = {};
      DIMS.forEach(d => {
        const rv = Number(raw[d] || 0);
        normed[d] = Number(normLookup(d, rv).toFixed(2));
      });

      // 3) compare to figures on NORMED scale
      let best=null,worst=null,bestSim=-Infinity,worstSim=Infinity;
      FIGURES.forEach(f=>{
        const sim=profileSimilarity(normed,f.profile);
        if(sim>bestSim){bestSim=sim;best=f;}
        if(sim<worstSim){worstSim=sim;worst=f;}
      });

      LAST_RESULT={best,bestSim,normed};

      // 4) render chart + text
      drawCompass(normed,best.profile);
      legendDiv.innerHTML='<span style="color:#38B000">■ Your profile</span><span style="color:#ff6e6e">■ '+best.name+'</span>';

      summaryDiv.innerHTML=`
        <h2>Most similar to: ${best.name}</h2>
        <p>${best.description}</p>
        <p><strong>Similarity (Koen):</strong> ${bestSim.toFixed(2)}</p>
        ${best.wiki?`<p><a href="${best.wiki}" target="_blank">Read more →</a></p>`:""}
        <h3>Least similar to: ${worst.name}</h3>
        <p>${worst.description}</p>
        <p><strong>Similarity (Koen):</strong> ${worstSim.toFixed(2)}</p>
      `;

      detailsDiv.innerHTML="";
      DIMS.forEach(d=>{
        detailsDiv.innerHTML+=`
          <div class="dim-desc">
            <strong>${d} - ${DIMS_INFO[d].name}</strong>: ${normed[d]}
            <div><em>High score:</em> ${DIMS_INFO[d].high}</div>
            <div><em>Low score:</em> ${DIMS_INFO[d].low}</div>
          </div>`;
      });

      document.getElementById('statusMsg').innerText = "✅ Results displayed below.";
      window.scrollTo({top:0,behavior:'smooth'});
    });

    document.getElementById('sendEmailBtn').addEventListener('click', async ()=>{
      const email = document.getElementById('userEmail').value;
      if(!LAST_RESULT){
        document.getElementById('emailFeedback').style.color="#d9534f";
        document.getElementById('emailFeedback').textContent="Please complete the test first.";
        return;
      }
      if(!email || !email.trim()){
        document.getElementById('emailFeedback').style.color="#d9534f";
        document.getElementById('emailFeedback').textContent="Please enter a valid email address.";
        return;
      }
      await sendEmail(email,LAST_RESULT.best,LAST_RESULT.bestSim,LAST_RESULT.normed);
    });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      document.getElementById('quiz').reset();
      document.getElementById('statusMsg').innerText="";
      const ctx=document.getElementById('compassCanvas').getContext('2d');
      ctx.clearRect(0,0,400,400);
      legendDiv.innerHTML="";
      summaryDiv.innerHTML="";
      detailsDiv.innerHTML="";
      document.getElementById('emailFeedback').textContent="";
      LAST_RESULT=null;
    });

    loadData();
  </script>
</body>
</html>
