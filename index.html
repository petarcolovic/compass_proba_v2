<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The 4C Culture Compass™ by Recrewty</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("buMM4aYEM_n4bPDZI");
    })();
  </script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#f8f9fa;
      --muted:#6c757d;
      --text:#333333;
      --accent:#38B000;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.5;
    }
    .wrap{max-width:1200px;margin:auto;padding:24px}
    header{
      display:flex;
      align-items:center;
      gap:12px;
      margin:16px 0 24px;
    }
    header img{height:40px}
    h1{font-size:26px;margin:0}
    .card{
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.1);
    }
    .intro{padding:16px 20px;margin-bottom:16px}
    .q{padding:16px 20px;border-top:1px solid rgba(0,0,0,.06);}
    .q:first-child{border-top:none}
    .q h3{font-size:16px;margin:0 0 12px}
    .scale{display:flex;gap:10px;flex-wrap:wrap}
    .scale label {
      display:flex;align-items:center;gap:8px;
      background:#ffffff;border:2px solid var(--accent);
      color:#333;padding:8px 12px;border-radius:12px;
      cursor:pointer;transition:all 0.2s ease;
    }
    .scale label:hover { background:var(--accent); color:#ffffff; }
    .scale input { accent-color:var(--accent); }
    .actions{display:flex;gap:12px;justify-content:flex-end;padding:14px 20px;border-top:1px solid rgba(0,0,0,.06)}
    button{background:var(--accent);border:none;color:#fff;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:20px}
    @media (min-width: 980px){ .grid{grid-template-columns:1fr 1fr} }
    .result{padding:16px 20px;text-align:center}
    .best-card{padding:16px 20px;border-top:1px solid rgba(0,0,0,.06);text-align:left}
    .best-card h2{margin:0 0 6px}
    a{color:#38B000}
    .small{font-size:12px}
    .dim-desc{margin:12px 0;font-size:14px;line-height:1.4;text-align:left}
    .legend{margin-top:10px;font-size:13px}
    .legend span{margin:0 10px}
    .compass-bg{position:relative;display:inline-block}
    .compass-bg img{width:400px;height:400px;display:block}
    .compass-bg canvas{position:absolute;left:0;top:0}
    .label{
      position:absolute;font-size:13px;font-weight:600;color:#444;
      background:rgba(255,255,255,0.8);padding:2px 6px;border-radius:6px;
      transform:translate(-50%,-50%);
    }
    #statusMsg{padding:10px 20px;font-size:14px;color:var(--accent);}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <a href="https://recrewty.com" target="_blank" rel="noopener">
        <img src="recrewty-logo-white.png" alt="Recrewty logo"/>
      </a>
      <h1>The 4C Culture Compass™ by Recrewty</h1>
    </header>

    <div class="grid">
      <!-- Leva strana: pitanja -->
      <form id="quiz" class="card">
        <div class="intro">
          <p class="muted">
            Odgovori za svaku tvrdnju od 1 (uopšte se ne slažem) do 5 (u potpunosti se slažem).<br>
            (Unos e-mail adrese je <strong>opcion</strong> — samo ako želiš da nam pošalješ rezultate za detaljniji izveštaj.)
          </p>
          <label><strong>Tvoj e-mail (opciono):</strong></label>
          <input type="email" id="userEmail" name="userEmail" placeholder="primer@domena.com"
                 style="width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc;">
        </div>
        <div id="questions"></div>
        <div id="statusMsg"></div>
        <div class="actions">
          <button type="submit">Pošalji</button>
          <button type="button" id="resetBtn" class="muted"
                  style="background:transparent;color:var(--text);border:1px solid rgba(0,0,0,.12)">Poništi</button>
        </div>
      </form>

      <!-- Desna strana: rezultati -->
      <section id="output" class="card" aria-live="polite">
        <div class="result">
          <div class="compass-bg" style="position:relative;">
            <img src="compass.svg" alt="Compass background"/>
            <canvas id="compassCanvas" width="400" height="400"></canvas>
            <div class="label" style="top:10px;left:50%;">C1</div>
            <div class="label" style="top:50%;left:95%;">C2</div>
            <div class="label" style="bottom:10px;left:50%;">C3</div>
            <div class="label" style="top:50%;left:5%;">C4</div>
          </div>
          <div id="legend"></div>
        </div>
        <div id="summary" class="best-card"></div>
        <div id="details"></div>
      </section>
    </div>
  </div>

  <script>
    let ITEMS = [];
    let FIGURES = [];

    async function loadData(){
      const itemsRes = await fetch("items.json");
      ITEMS = await itemsRes.json();
      const figuresRes = await fetch("figures.json");
      FIGURES = await figuresRes.json();
      renderQuestions();
    }

    const DIMS = ["C1","C2","C3","C4"];
    const qWrap = document.getElementById('questions');
    const legendDiv = document.getElementById('legend');
    const summaryDiv = document.getElementById('summary');
    const detailsDiv = document.getElementById('details');

    function renderQuestions(){
      qWrap.innerHTML = '';
      ITEMS.forEach(q=>{
        const div=document.createElement('div');
        div.className='q';
        div.innerHTML=`
          <h3>${q.id}. ${q.text}</h3>
          <div class="scale">
            ${[1,2,3,4,5].map(v=>`
              <label>
                <input type="radio" name="q_${q.id}" value="${v}" required /> ${v}
              </label>`).join('')}
          </div>
          <div class="small muted">Skala: 1 = nimalo • 5 = u potpunosti</div>`;
        qWrap.appendChild(div);
      });
    }

    function computeRawScores(form){
      const sums={};
      ITEMS.forEach(q=>{sums[q.dim]=(sums[q.dim]||0)+Number(form.get(`q_${q.id}`)||0);});
      return sums;
    }

    function profileSimilarity(user, fig){
      const u=DIMS.map(d=>user[d]||0);
      const f=DIMS.map(d=>fig[d]||0);
      const meanU=u.reduce((a,b)=>a+b,0)/u.length;
      const meanF=f.reduce((a,b)=>a+b,0)/u.length;
      let num=0,denU=0,denF=0;
      for(let i=0;i<DIMS.length;i++){
        num+=(u[i]-meanU)*(f[i]-meanF);
        denU+=(u[i]-meanU)**2;
        denF+=(f[i]-meanF)**2;
      }
      return num/Math.sqrt(denU*denF);
    }

    function drawCompass(user,figure){
      const canvas=document.getElementById('compassCanvas');
      const ctx=canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const size=canvas.width;
      const radius=size*0.36;
      const centerX=size/2,centerY=size/2;
      const angles=[-Math.PI/2,0,Math.PI/2,Math.PI];

      function drawPoly(obj,color){
        ctx.beginPath();
        DIMS.forEach((dim,i)=>{
          const val=obj[dim]||0;
          const r=(val/100)*radius;
          const x=centerX+r*Math.cos(angles[i]);
          const y=centerY+r*Math.sin(angles[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.closePath();
        ctx.fillStyle=color.replace('1)','0.3)');
        ctx.fill();
        ctx.strokeStyle=color;
        ctx.lineWidth=2;
        ctx.stroke();
      }

      drawPoly(user,'rgba(56,176,0,1)');
      drawPoly(figure,'rgba(255,110,110,1)');
    }

    async function sendEmail(email, best, sim, scores){
      try {
        await emailjs.send("service_scxnyg8","template_9asmc9m",{
          user_email: email,
          best_name: best.name,
          best_sim: sim.toFixed(2),
          C1: scores["C1"].toFixed(2),
          C2: scores["C2"].toFixed(2),
          C3: scores["C3"].toFixed(2),
          C4: scores["C4"].toFixed(2)
        });
        document.getElementById('statusMsg').innerText = "✅ Rezultati su prikazani i poslati na e-mail.";
      } catch (err) {
        document.getElementById('statusMsg').innerText = "⚠️ Rezultati prikazani, ali slanje nije uspelo.";
      }
    }

    document.getElementById('quiz').addEventListener('submit', async e=>{
      e.preventDefault();
      const form=new FormData(e.target);
      const email=form.get("userEmail");
      const raw=computeRawScores(form);
      const normed={C1:raw.C1||0,C2:raw.C2||0,C3:raw.C3||0,C4:raw.C4||0};

      let best=null,worst=null,bestSim=-Infinity,worstSim=Infinity;
      FIGURES.forEach(f=>{
        const sim=profileSimilarity(normed,f.profile);
        if(sim>bestSim){bestSim=sim;best=f;}
        if(sim<worstSim){worstSim=sim;worst=f;}
      });

      drawCompass(normed,best.profile);
      legendDiv.innerHTML='<span style="color:#38B000">■ Tvoj profil</span><span style="color:#ff6e6e">■ '+best.name+'</span>';
      summaryDiv.innerHTML=`<h2>Najsličniji si: ${best.name}</h2><p>${best.description}</p><p><strong>Sličnost:</strong> ${bestSim.toFixed(2)}</p>`;
      detailsDiv.innerHTML=DIMS.map(d=>`<div class='dim-desc'><strong>${d}</strong>: ${normed[d]}</div>`).join('');

      if(email && email.trim()!==""){
        await sendEmail(email,best,bestSim,normed);
      } else {
        document.getElementById('statusMsg').innerText = "✅ Rezultati prikazani (e-mail nije unet).";
      }

      window.scrollTo({top:0,behavior:'smooth'});
    });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      document.getElementById('quiz').reset();
      document.getElementById('statusMsg').innerText="";
      const ctx=document.getElementById('compassCanvas').getContext('2d');
      ctx.clearRect(0,0,400,400);
      legendDiv.innerHTML="";
      summaryDiv.innerHTML="";
      detailsDiv.innerHTML="";
    });

    loadData();
  </script>
</body>
</html>
